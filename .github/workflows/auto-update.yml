name: Auto Update Dependencies

on:
  schedule:
    # Ù‡Ø± Ù‡ÙØªÙ‡ ÛŒÚ©Ø´Ù†Ø¨Ù‡ Ø¯Ø± Ø³Ø§Ø¹Øª 9 ØµØ¨Ø­ UTC
    - cron: '0 9 * * 0'
  workflow_dispatch:

jobs:
  update-dependencies:
    name: Update Flutter Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.8.1'
        channel: 'stable'
        cache: true
    
    - name: Check for outdated packages
      id: check_outdated
      run: |
        flutter pub outdated --json > outdated.json
        if [ $(cat outdated.json | jq '.packages | length') -gt 0 ]; then
          echo "has_updates=true" >> $GITHUB_OUTPUT
        else
          echo "has_updates=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Update dependencies
      if: steps.check_outdated.outputs.has_updates == 'true'
      run: |
        flutter pub upgrade
        flutter pub get
    
    - name: Run tests after update
      if: steps.check_outdated.outputs.has_updates == 'true'
      run: |
        flutter analyze
        flutter test
    
    - name: Create Pull Request
      if: steps.check_outdated.outputs.has_updates == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: update Flutter dependencies'
        title: 'ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§'
        body: |
          ## ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
          
          Ø§ÛŒÙ† PR Ø¨Ù‡ Ø·ÙˆØ± Ø®ÙˆØ¯Ú©Ø§Ø± ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Flutter Ø±Ø§ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª.
          
          ### ØªØºÛŒÛŒØ±Ø§Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡:
          - Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ packages Ø¯Ø± pubspec.yaml
          - Ø§Ø¬Ø±Ø§ÛŒ flutter pub upgrade
          - Ø¨Ø±Ø±Ø³ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ Ùˆ ØªØ­Ù„ÛŒÙ„ Ú©Ø¯
          
          ### Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø¯Ù‡:
          - âœ… ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ Ù¾Ø§Ø³ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯
          - âœ… ØªØ­Ù„ÛŒÙ„ Ú©Ø¯ Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø§
          - âœ… Ù¾Ø±ÙˆÚ˜Ù‡ Ù‚Ø§Ø¨Ù„ build Ø§Ø³Øª
          
          Ù„Ø·ÙØ§Ù‹ Ù‚Ø¨Ù„ Ø§Ø² mergeØŒ ÛŒÚ© Ø¨Ø§Ø± Ø¯ÛŒÚ¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.
        branch: chore/update-dependencies
        delete-branch: true

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.8.1'
        channel: 'stable'
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Run security audit
      run: |
        echo "ğŸ” Running security audit..."
        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ
        flutter pub deps | grep -E "(http|crypto|auth)" || echo "No security-related packages found"
    
    - name: Check for sensitive files
      run: |
        echo "ğŸ”’ Checking for sensitive files..."
        if find . -name "*.key" -o -name "*.keystore" -o -name ".env" | grep -v .git | head -5; then
          echo "âš ï¸  Sensitive files found! Please ensure they are in .gitignore"
        else
          echo "âœ… No sensitive files found in repository"
        fi
